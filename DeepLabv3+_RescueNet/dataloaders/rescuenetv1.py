'''
Masks are generated by my own scritps. Mask of all classes in uint8 format means multi hot encoded. 
This script tries to segment all types of classes.
Classes are: {'Background':0, 'Debris':1, 'Water':2, 'Building_No_Damage':3, 'Building_Minor_Damage':4, 'Building_Major_Damage':5, 
            'Building_Total_Destruction':6, 'Vehicle':7, 'Road':8, 'Tree':9, 'Pool':10, 'Sand':11}

'''

from base import BaseDataSet, BaseDataLoader
from utils import palette
from glob import glob
import numpy as np 
import os
import cv2
import torch
from PIL import Image
from torch.utils.data import Dataset
from torchvision import transforms

#ignore_label = 255
ID_TO_TRAINID = {0: 0, 1:1, 2:2, 3:3, 4:4, 5:5, 6:6, 7:7, 8:8, 9:9, 10:10, 11:11}
'''
ID_TO_TRAINID = {0: 0, 255:1}
'''

class RescueNetDataset(BaseDataSet):
    def __init__(self, mode='fine', **kwarg):
        self.num_classes = 12
        self.palette = palette.RescueNet_palette_all
        self.id_to_trainid = ID_TO_TRAINID
        super(RescueNetDataset, self).__init__(**kwarg)

    def _set_files(self):
        SUFIX_IMG = '.jpg'
        SUFIX_LABEL = '.png'
        img_dir_name = 'RescueNet'
        split = self.split
        img_path = os.path.join(self.root, img_dir_name, self.split, split + '-org-img')
        label_path = os.path.join(self.root, img_dir_name, self.split, split + '-label-img')

        img_paths, label_paths = [], []
        img_paths.extend(sorted(glob(os.path.join(img_path, f'*{SUFIX_IMG}'))))
        label_paths.extend(sorted(glob(os.path.join(label_path, f'*{SUFIX_LABEL}'))))
        # @sh: add
        print(len(img_paths))
        print(len(label_paths))
        self.files = list(zip(img_paths,  label_paths))

    def _load_data(self, index):
        img_path, label_path = self.files[index]
        img_id = os.path.splitext(os.path.basename(img_path))[0]
        img = np.asarray(Image.open(img_path).convert('RGB'), dtype=np.float32)
        label = np.asarray(Image.open(label_path), dtype=np.float32)

        for k, v in self.id_to_trainid.items():
            label[ label == k] = v

        return img, label, img_id


class RescueNet(BaseDataLoader):
    def __init__(self, data_dir, batch_size, split, crop_size=None, base_size=None, scale=True, num_workers=1, mode='fine', val=False,
                    shuffle=False, flip=False, rotate=False, blur= False, augment=False, val_split= None, return_id=False):

        self.MEAN = [0.28689529, 0.32513294, 0.28389176] # how to calculate them for uavdataset??
        self.STD = [0.17613647, 0.18099176, 0.17772235] # how to calculate them for uavdataset??

        kwargs = {
            'root': data_dir,
            'split': split,
            'mean': self.MEAN,
            'std': self.STD,
            'augment': augment,
            'crop_size': crop_size,
            'base_size': base_size,
            'scale': scale,
            'flip': flip,
            'blur': blur,
            'rotate': rotate,
            'return_id': return_id,
            'val': val
        }

        self.dataset = RescueNetDataset(mode=mode, **kwargs)
        super(RescueNet, self).__init__(self.dataset, batch_size, shuffle, num_workers, val_split)

